<html>
<head>
    <title>3D Tower Defense</title>
    <style>
        body { margin: 0; }
        canvas { width: 100%; height: 100% }
        #tower {
            text-align: center;
            padding: 10px;
            z-index: 10;
            width: 100%;
            position: absolute;
        }
    </style>
</head>
<body>
    <div id="tower">
        <button type="button" id="addTowerButton">Add Tower</button>
        <button type="button" id="addBallButton">Add Ball</button>
    </div>
    <script type="text/javascript" src="libs/three.min.js"></script>
    <script type="text/javascript" src="libs/TrackballControls.js"></script>
    <script type="text/javascript" src="libs/tween.min.js"></script>
    <script type="text/javascript" src="libs/physi.js"></script>
    <script type="text/javascript" src="js/tower.js"></script>
    <script type="text/javascript" src="js/enemy.js"></script>
    <script type="text/javascript">

        Physijs.scripts.worker = 'libs/physijs_worker.js';
        Physijs.scripts.ammo = '../libs/ammo.js';

        var camera, renderer, scene;
        var plane;
        var controls;
        var stats;
        var light;
        var clock = new THREE.Clock();
        var addTowerBoolean = false;
        var towers = [];
        var ball;
        var img;
        var uniforms
        var plane1

        init();
        animate();

        document.getElementById("addTowerButton").onclick = function() {addTowerBoolean = true;}
        document.getElementById("addBallButton").onclick = addBall;
        document.addEventListener("mousedown", onDocumentMouseDown);

        function init() {
            //Kamera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            //camera.position.x = 50;
            camera.position.z = 50;
            //camera.position.y = -50;
            //camera.rotation.x=-0.5*Math.PI;

            //Controls
            controls = new THREE.TrackballControls(camera);
            controls.rotateSpeed = 1.0;
            controls.addEventListener('change', render);

            //Svet
            scene = new Physijs.Scene();
            scene.setGravity(new THREE.Vector3(0,0,-5));


            var planeGeo = new THREE.PlaneGeometry(100, 100, 1, 1);
            var planeMaterial = new THREE.MeshLambertMaterial({color: 0xffffff});
            plane1 = new Physijs.PlaneMesh(planeGeo, planeMaterial);
            //plane.name = "plane";
            //plane1.receiveShadow = true;
            scene.add(plane1)
            var axes = new THREE.AxisHelper(20);
            scene.add(axes)

            img = new Image();
            img.onload = addPlane;
            img.src = "assets/plane201.png"
            //addTerrain();
            //addPlane();

            /*var loader = new THREE.JSONLoader();
            loader.load("assets/kupola.json", function(geometry) {
                var material = new THREE.MeshBasicMaterial();
                var mesh = new THREE.Mesh(geometry, material);
                scene.add(mesh)
            });*/


            //Luci
            light = new THREE.DirectionalLight( 0xffffff );
            light.position.set( 100, 100, 100);
            light.castShadow = true;
            //light.target = plane;
            scene.add( light );

            ambientLight = new THREE.AmbientLight( 0xffffff );
            scene.add( ambientLight );

            camera.lookAt(scene.position);

            //Renderer
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0xeeeeee, 1.0);
            renderer.shadowMapType = THREE.PCFSoftShadowMap;
            renderer.shadowMapEnabled = true;
            document.body.appendChild(renderer.domElement);
            render();

        }

        function getHeightData(img,scale) {

            if (scale == undefined) scale=1;

            var canvas = document.createElement( 'canvas' );
            canvas.width = img.width;
            canvas.height = img.height;

            var context = canvas.getContext( '2d' );

            var size = img.width * img.height;
            var data = new Float32Array( size );

            context.drawImage(img,0,0);

            for ( var i = 0; i < size; i ++ ) {
                data[i] = 0
            }

            var imgd = context.getImageData(0, 0, img.width, img.height);
            var pix = imgd.data;

            var j=0;
            for (var i = 0; i<pix.length; i +=4) {
                var all = 0.299 * pix[i] + 0.587 * pix[i+1]+ 0.114 * pix[i+2];
                data[j++] = all/(12*scale);
            }

            return data;
        }

        function addPlane() {
            //get height data from img
            var data = getHeightData(img,0.5);

            // plane
            var geometry = new THREE.PlaneGeometry(150,150,200,200);
            var texture = THREE.ImageUtils.loadTexture( 'assets/plane201.png' );
            var material = new THREE.MeshLambertMaterial( { map: texture, wireframe: true } );
            //plane = new Physijs.PlaneMesh( geometry, material );

            //set height of vertices
            for ( var i = 0; i<geometry.vertices.length; i++ ) {
                geometry.vertices[i].z = data[i];
            }
            geometry.computeFaceNormals();
            geometry.computeVertexNormals();
            plane = new Physijs.HeightfieldMesh( geometry, material, 0, 200 ,200);
            scene.add(plane);
            render();
            //plane.visible = false;
        }

        function addTerrain() {
            var terrainTexture = new THREE.ImageUtils.loadTexture("assets/surface_test.png");

            shader = THREE.ShaderLib[ "normalmap" ];
            uniforms = THREE.UniformsUtils.clone( shader.uniforms );

            uniforms[ "enableDisplacement" ].value = true;
            uniforms[ "enableDiffuse" ].value = true;
            uniforms[ "tDisplacement" ].value = terrainTexture;
            uniforms[ "tDiffuse" ].value = terrainTexture;
            uniforms[ "uDisplacementScale" ].value = 43;

            var parameters = { fragmentShader: shader.fragmentShader, vertexShader: shader.vertexShader, uniforms: uniforms, lights: true, wireframe: false };
            var planeMaterial = new THREE.ShaderMaterial( parameters );

            var planeGeo = new THREE.PlaneGeometry(250, 250, 150, 150);
            planeGeo.computeTangents(); /**/

            //var planeMaterial = new THREE.MeshLambertMaterial({color: 0xffffff}); /**/

            var terrain = new THREE.Mesh(planeGeo, planeMaterial);
            terrain.name = "terrain";
            terrain.receiveShadow = true;
            scene.add(terrain);
        }
        //Dodajanje zoge
        function addBall() {
            var ballGeometry = new THREE.SphereGeometry(1, 20, 20);
            var ballMaterial = new THREE.MeshBasicMaterial({color: 0xff0000});
            ball = new Physijs.SphereMesh(ballGeometry, ballMaterial, 10);
            /*ball.addEventListener('collision', function(collided_with, linearVelocity, angularVelocity) {
                console.log("TEST");
            });*/
            //ball = new THREE.Mesh(ballGeometry, ballMaterial);
            ball.castShadow = true;
            ball.position.z = 35;
            ball.addEventListener( 'collision', function( other_object, linear_velocity, angular_velocity ) {
                console.log("sfag");
            });
            //initBallTween(ball);
            scene.add(ball);
            //document.getElementById("addBallButton").disabled = true;
        }

        //iniclizacija animacije zoge
        function initBallTween(ball) {
            var current = {x: 0};
            var update = function () {
                ball.__dirtyPosition = true;
                ball.position.x = current.x;
            }

            var tweenHead = new TWEEN.Tween(current).to({x: 20}, 5000)
                    .easing(TWEEN.Easing.Quadratic.InOut)
                    .onUpdate(update);

            var tweenBack = new TWEEN.Tween(current).to({x: -20}, 5000)
                    .easing(TWEEN.Easing.Quadratic.InOut)
                    .onUpdate(update);

            tweenBack.chain(tweenHead);
            tweenHead.chain(tweenBack);
            tweenHead.start();
        }

        //Zgradi stolp in ga doda na sceno
        function addTower(vector) {
            if(addTowerBoolean == false) {
                return;
            }
            //ustvari grupo
            var towerGroup = new  THREE.Group();
            towerGroup.position.x = vector.x;
            towerGroup.position.y = vector.y;
            towerGroup.position.z = vector.z + 6;
            towerGroup.rotation.x = 0.5 * Math.PI;

            //spodni del stolpa
            var base_texture = THREE.ImageUtils.loadTexture("assets/tower_base.gif")
            var baseGeometry = new THREE.CylinderGeometry(3, 6, 12);
            var baseMaterial = new THREE.MeshLambertMaterial();
            baseMaterial.map = base_texture;
            var base = new THREE.Mesh(baseGeometry, baseMaterial);
            base.castShadow = true;

            //top
            var canon_texture = THREE.ImageUtils.loadTexture("assets/top.gif");
            var topGeometry = new THREE.CylinderGeometry(1, 1, 5);
            var topMaterial = new THREE.MeshPhongMaterial();
            topMaterial.map = canon_texture;
            var top = new THREE.Mesh(topGeometry, topMaterial);
            top.name = "top";
            top.position.y = 11;
            top.rotation.x = 0.5 * Math.PI;
            top.castShadow = true;


            //var range = new Physijs.SphereMesh(new THREE.SphereGeometry(5, 20 ,20),
                       //                         new THREE.MeshBasicMaterial({wireframe: true}), 5);

            //range.position.z = 10;

            //range.addEventListener('collision', function(collided_with, linearVelocity, angularVelocity) {
               // console.log("TEST");
            //});
            //range._physijs.collision_flags = 4;
           // range.name = "range";



            //zdruzi v grupo in doda na sceno
            towerGroup.add(base);
            towerGroup.add(top);
            scene.add(towerGroup);
            //scene.add(range);
            //towers.push(towerGroup);
            addTowerBoolean = false;

        }


        var projector = new THREE.Projector();
        function onDocumentMouseDown(event) {
            event.preventDefault();
            var vector = new THREE.Vector3(
                    (event.clientX / window.innerWidth ) * 2 - 1,
                    -( event.clientY / window.innerHeight ) * 2 + 1,
                    0.5);
            projector.unprojectVector(vector, camera);
            var raycaster = new THREE.Raycaster(camera.position,
                    vector.sub(camera.position).normalize());
            var intersects = raycaster.intersectObjects([plane]);
            if (intersects.length > 0) {
                addTower(intersects[0].point);
            }
        }

        function animateTowers() {
            towers.forEach(function(e) {
                if (ball === undefined || ball === null) {
                    return;
                }
                var top = e.getObjectByName("top");
                top.lookAt(ball.position);
            });
        }

        function animate() {
            render();
            var delta = clock.getDelta();
            controls.update(delta);
            TWEEN.update();
            animateTowers();
            scene.simulate();
            requestAnimationFrame( animate );
        }

        function render() {
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>